---
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import PostCard from '../components/PostCard.astro';
import TrackingScripts from '../components/TrackingScripts.astro';
import { getDb, posts } from '../lib/db';
import { eq, desc } from 'drizzle-orm';
import '../styles/global.css';

const PER_PAGE = 12;

const db = getDb(Astro.locals.runtime.env.DB);
const allPosts = await db
  .select()
  .from(posts)
  .where(eq(posts.status, 'published'))
  .orderBy(desc(posts.publishedAt))
  .all();

const tag = Astro.url.searchParams.get('tag');
const pageParam = parseInt(Astro.url.searchParams.get('page') ?? '1', 10);
const page = isNaN(pageParam) || pageParam < 1 ? 1 : pageParam;

const filteredPosts = tag
  ? allPosts.filter((p) => {
      try { return (JSON.parse(p.tags) as string[]).includes(tag); }
      catch { return false; }
    })
  : allPosts;

const totalPages = Math.max(1, Math.ceil(filteredPosts.length / PER_PAGE));
const safePage = Math.min(page, totalPages);
const pagePosts = filteredPosts.slice((safePage - 1) * PER_PAGE, safePage * PER_PAGE);

// Collect all tags for filter
const allTags = [...new Set(allPosts.flatMap((p) => {
  try { return JSON.parse(p.tags) as string[]; }
  catch { return []; }
}))].sort();

function pageUrl(p: number) {
  const params = new URLSearchParams();
  if (tag) params.set('tag', tag);
  if (p > 1) params.set('page', String(p));
  const qs = params.toString();
  return qs ? `/?${qs}` : '/';
}

// Show at most 5 page numbers around current page
function pageNumbers(): (number | '...')[] {
  if (totalPages <= 7) return Array.from({ length: totalPages }, (_, i) => i + 1);
  const pages: (number | '...')[] = [1];
  if (safePage > 3) pages.push('...');
  for (let i = Math.max(2, safePage - 1); i <= Math.min(totalPages - 1, safePage + 1); i++) pages.push(i);
  if (safePage < totalPages - 2) pages.push('...');
  pages.push(totalPages);
  return pages;
}
---

<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{safePage > 1 ? `Blog — Página ${safePage}` : 'Blog do Thiago — Desenvolvimento e tecnologia'}</title>
  <meta name="description" content="Blog sobre desenvolvimento web, cloud e tecnologia." />
  {safePage > 1 && <meta name="robots" content="noindex, follow" />}
  <link rel="alternate" type="application/rss+xml" title="Blog do Thiago RSS" href="/rss.xml" />
  <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
  {safePage > 1 && <link rel="prev" href={pageUrl(safePage - 1)} />}
  {safePage < totalPages && <link rel="next" href={pageUrl(safePage + 1)} />}
  <TrackingScripts />
</head>
<body class="bg-zinc-950 text-zinc-100 min-h-screen flex flex-col">
  <Header />

  <main class="max-w-4xl mx-auto px-4 py-12 flex-1 w-full">
    <!-- Hero -->
    <div class="mb-10">
      <h1 class="text-4xl font-bold text-zinc-100 mb-2">Blog</h1>
      <p class="text-zinc-400">Artigos sobre desenvolvimento web, cloud e tecnologia.</p>
    </div>

    <!-- Tag filter -->
    {allTags.length > 0 && (
      <div class="flex flex-wrap gap-2 mb-8">
        <a
          href="/"
          class={`text-xs px-3 py-1 rounded-full transition-colors ${!tag ? 'bg-indigo-600 text-white' : 'bg-zinc-800 text-zinc-400 hover:text-zinc-100'}`}
        >
          Todos
        </a>
        {allTags.map((t) => (
          <a
            href={`/?tag=${t}`}
            class={`text-xs px-3 py-1 rounded-full transition-colors ${tag === t ? 'bg-indigo-600 text-white' : 'bg-zinc-800 text-zinc-400 hover:text-zinc-100'}`}
          >
            #{t}
          </a>
        ))}
      </div>
    )}

    <!-- Posts -->
    {pagePosts.length === 0 ? (
      <div class="text-center py-20 text-zinc-600">
        <p class="text-lg">Nenhum post publicado ainda.</p>
        {Astro.locals.user && (
          <a href="/admin/posts/new" class="inline-block mt-4 text-indigo-400 hover:text-indigo-300">
            Criar primeiro post →
          </a>
        )}
      </div>
    ) : (
      <div class="grid gap-4 sm:grid-cols-2">
        {pagePosts.map((post, i) => (
          <div class="fade-in-up" style={`animation-delay: ${i * 60}ms`}>
            <PostCard post={post} />
          </div>
        ))}
      </div>
    )}

    <!-- Pagination -->
    {totalPages > 1 && (
      <nav class="flex items-center justify-center gap-1 mt-12" aria-label="Paginação">
        {safePage > 1 ? (
          <a href={pageUrl(safePage - 1)} class="flex items-center gap-1 px-3 py-2 text-sm text-zinc-400 hover:text-zinc-100 bg-zinc-900 border border-zinc-800 hover:border-zinc-700 rounded-lg transition-colors">
            ← Anterior
          </a>
        ) : (
          <span class="flex items-center gap-1 px-3 py-2 text-sm text-zinc-700 bg-zinc-900 border border-zinc-800 rounded-lg cursor-not-allowed">
            ← Anterior
          </span>
        )}

        {pageNumbers().map((p) => (
          p === '...' ? (
            <span class="px-2 py-2 text-sm text-zinc-600">…</span>
          ) : (
            <a
              href={pageUrl(p as number)}
              class={`w-9 h-9 flex items-center justify-center text-sm rounded-lg border transition-colors ${
                p === safePage
                  ? 'bg-indigo-600 border-indigo-600 text-white font-semibold'
                  : 'bg-zinc-900 border-zinc-800 text-zinc-400 hover:text-zinc-100 hover:border-zinc-700'
              }`}
              aria-current={p === safePage ? 'page' : undefined}
            >
              {p}
            </a>
          )
        ))}

        {safePage < totalPages ? (
          <a href={pageUrl(safePage + 1)} class="flex items-center gap-1 px-3 py-2 text-sm text-zinc-400 hover:text-zinc-100 bg-zinc-900 border border-zinc-800 hover:border-zinc-700 rounded-lg transition-colors">
            Próximo →
          </a>
        ) : (
          <span class="flex items-center gap-1 px-3 py-2 text-sm text-zinc-700 bg-zinc-900 border border-zinc-800 rounded-lg cursor-not-allowed">
            Próximo →
          </span>
        )}
      </nav>
    )}

    {totalPages > 1 && (
      <p class="text-center text-xs text-zinc-700 mt-3">
        Página {safePage} de {totalPages} — {filteredPosts.length} posts
      </p>
    )}
  </main>

  <Footer />
</body>
</html>
