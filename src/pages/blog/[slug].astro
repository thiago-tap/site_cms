---
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import SEO from '../../components/SEO.astro';
import TOC from '../../components/TOC.astro';
import ShareButtons from '../../components/ShareButtons.astro';
import RelatedPosts from '../../components/RelatedPosts.astro';
import GiscusComments from '../../components/GiscusComments.astro';
import NewsletterForm from '../../components/NewsletterForm.astro';
import { getDb, posts, postViewsLog, postReferrers } from '../../lib/db';
import { eq, ne, desc, sql } from 'drizzle-orm';
import SeriesNav from '../../components/SeriesNav.astro';
import TrackingScripts from '../../components/TrackingScripts.astro';
import { renderMarkdown, extractHeadings, hasTwitterEmbed } from '../../lib/markdown';
import { getRelatedPosts } from '../../lib/embeddings';
import { getSettings } from '../../lib/settings';
import { formatDate, parseTags, imgProxy } from '../../lib/utils';
import '../../styles/global.css';

const { slug } = Astro.params;
if (!slug) return Astro.redirect('/');

const db = getDb(Astro.locals.runtime.env.DB);
const [post, config] = await Promise.all([
  db.select().from(posts).where(eq(posts.slug, slug)).get(),
  getSettings(Astro.locals.runtime.env.DB),
]);

if (!post || post.status !== 'published') {
  return new Response(null, { status: 404 });
}

// Increment views async + log daily view + log referrer
const today = new Date().toISOString().split('T')[0];
db.update(posts).set({ views: post.views + 1 }).where(eq(posts.id, post.id)).run().catch(() => {});
db.run(sql`
  INSERT INTO post_views_log (post_id, day, count) VALUES (${post.id}, ${today}, 1)
  ON CONFLICT(post_id, day) DO UPDATE SET count = count + 1
`).catch(() => {});
// Log referrer
const refHeader = Astro.request.headers.get('referer') ?? '';
const refHost = (() => {
  try { return new URL(refHeader).hostname || 'direct'; }
  catch { return 'direct'; }
})();
db.run(sql`
  INSERT INTO post_referrers (post_id, day, referrer, count) VALUES (${post.id}, ${today}, ${refHost}, 1)
  ON CONFLICT(post_id, day, referrer) DO UPDATE SET count = count + 1
`).catch(() => {});

const html = renderMarkdown(post.content);
const headings = extractHeadings(post.content);
const tags = parseTags(post.tags);
const needsTwitterWidget = hasTwitterEmbed(html);
const siteUrl = Astro.locals.runtime.env.SITE_URL ?? 'https://thiago.catiteo.com';
const postUrl = `${siteUrl}/blog/${post.slug}`;

// All published posts for prev/next and related
const allPublished = await db.select().from(posts)
  .where(eq(posts.status, 'published'))
  .orderBy(desc(posts.publishedAt))
  .all();

const currentIndex = allPublished.findIndex((p) => p.id === post.id);
const prevPost = currentIndex < allPublished.length - 1 ? allPublished[currentIndex + 1] : null;
const nextPost = currentIndex > 0 ? allPublished[currentIndex - 1] : null;

// Related posts via AI embeddings (fallback: tag similarity)
const related = await getRelatedPosts(Astro.locals.runtime.env.DB, post.id, allPublished, 3);

// Series nav
const seriesPosts = post.series
  ? allPublished.filter((p) => p.series === post.series)
  : [];
---

<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <SEO
    title={post.title}
    description={post.metaDescription ?? post.excerpt ?? post.title}
    image={post.coverImage ?? undefined}
    type="article"
    publishedAt={post.publishedAt}
    updatedAt={post.updatedAt}
    tags={tags}
    siteName={config.site_name}
    siteUrl={siteUrl}
    authorName={config.author_name}
    wordCount={post.readingTime * 200}
  />
  <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
  <link rel="alternate" type="application/rss+xml" title={config.site_name} href="/rss.xml" />
  <TrackingScripts />
  {needsTwitterWidget && <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>}
</head>
<body class="bg-zinc-950 text-zinc-100 min-h-screen flex flex-col">
  <!-- Reading progress bar -->
  <div id="reading-progress"></div>

  <Header />

  <main class="max-w-3xl mx-auto px-4 py-12 flex-1 w-full">
    <!-- Breadcrumbs -->
    <nav class="flex items-center gap-1.5 text-xs text-zinc-600 mb-6" aria-label="Breadcrumb">
      <a href="/" class="hover:text-zinc-400 transition-colors">Blog do Thiago</a>
      <span>/</span>
      <a href="/" class="hover:text-zinc-400 transition-colors">Blog</a>
      <span>/</span>
      <span class="text-zinc-400 truncate max-w-xs">{post.title}</span>
    </nav>

    {post.coverImage && (
      <img
        src={imgProxy(post.coverImage, 1344)!}
        alt={post.title}
        width="1344"
        height="756"
        fetchpriority="high"
        decoding="async"
        class="w-full rounded-xl mb-8 aspect-video object-cover cursor-zoom-in prose-img"
        data-zoomable
        data-full={post.coverImage}
      />
    )}

    <header class="mb-8">
      {tags.length > 0 && (
        <div class="flex flex-wrap gap-1.5 mb-4">
          {tags.map((tag) => (
            <a href={`/?tag=${tag}`} class="text-xs bg-zinc-800 text-zinc-400 hover:text-zinc-200 px-2 py-0.5 rounded-md transition-colors">
              #{tag}
            </a>
          ))}
        </div>
      )}
      <h1 class="text-3xl font-bold text-zinc-100 mb-4 leading-tight">{post.title}</h1>
      <div class="flex items-center gap-4 text-sm text-zinc-500">
        {post.publishedAt && <span>{formatDate(post.publishedAt)}</span>}
        <span>{post.readingTime} min de leitura</span>
        <span class="flex items-center gap-1">
          <svg class="w-3.5 h-3.5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>
          </svg>
          {post.views + 1}
        </span>
      </div>
    </header>

    <!-- Series navigation -->
    {post.series && seriesPosts.length > 1 && (
      <SeriesNav series={post.series} posts={seriesPosts} currentId={post.id} />
    )}

    <!-- AI Summary -->
    {post.aiSummary && (
      <div class="bg-indigo-500/5 border border-indigo-500/20 rounded-xl p-5 mb-8">
        <div class="flex items-center gap-2 text-indigo-400 text-sm font-medium mb-2">
          <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v1a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-1H2a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h1a7 7 0 0 1 7-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 0 1 2-2z"/>
          </svg>
          Resumo gerado por IA
        </div>
        <p class="text-sm text-zinc-300 leading-relaxed">{post.aiSummary}</p>
      </div>
    )}

    <!-- Table of Contents -->
    <TOC headings={headings} />

    <!-- Content -->
    <div class="prose" id="post-content">
      <Fragment set:html={html} />
    </div>

    <!-- Share -->
    <ShareButtons url={postUrl} title={post.title} />

    <!-- Edit link -->
    {Astro.locals.user && (
      <div class="mt-6 pt-6 border-t border-zinc-800">
        <a href={`/admin/posts/${post.id}`} class="text-sm text-indigo-400 hover:text-indigo-300 transition-colors">
          ✏️ Editar este post
        </a>
      </div>
    )}

    <!-- Newsletter -->
    <NewsletterForm enabled={config.newsletter_enabled === '1'} />

    <!-- Giscus comments -->
    <GiscusComments
      repo={config.giscus_repo}
      repoId={config.giscus_repo_id}
      category={config.giscus_category}
      categoryId={config.giscus_category_id}
    />

    <!-- Related posts -->
    <RelatedPosts posts={related} />

    <!-- Prev / Next navigation -->
    {(prevPost || nextPost) && (
      <nav class="mt-12 pt-8 border-t border-zinc-800 grid grid-cols-2 gap-4 not-prose">
        <div>
          {prevPost && (
            <a href={`/blog/${prevPost.slug}`} class="group flex flex-col gap-1 p-4 bg-zinc-900 border border-zinc-800 hover:border-zinc-700 rounded-xl transition-colors">
              <span class="text-xs text-zinc-600">← Anterior</span>
              <span class="text-sm font-medium text-zinc-300 group-hover:text-zinc-100 line-clamp-2 transition-colors">{prevPost.title}</span>
            </a>
          )}
        </div>
        <div class="text-right">
          {nextPost && (
            <a href={`/blog/${nextPost.slug}`} class="group flex flex-col gap-1 p-4 bg-zinc-900 border border-zinc-800 hover:border-zinc-700 rounded-xl transition-colors">
              <span class="text-xs text-zinc-600">Próximo →</span>
              <span class="text-sm font-medium text-zinc-300 group-hover:text-zinc-100 line-clamp-2 transition-colors">{nextPost.title}</span>
            </a>
          )}
        </div>
      </nav>
    )}
  </main>

  <!-- Back to top button -->
  <button id="back-to-top" aria-label="Voltar ao topo" title="Voltar ao topo">
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M18 15l-6-6-6 6"/>
    </svg>
  </button>

  <!-- Image lightbox -->
  <div id="img-lightbox" style="display:none" role="dialog" aria-modal="true">
    <img id="img-lightbox-src" src="" alt="" />
  </div>

  <Footer />

  <script>
    // ── Reading progress ──
    const progressBar = document.getElementById('reading-progress') as HTMLDivElement;
    const content = document.getElementById('post-content');
    function updateProgress() {
      if (!content || !progressBar) return;
      const rect = content.getBoundingClientRect();
      const total = content.offsetHeight - window.innerHeight;
      const scrolled = Math.max(0, -rect.top);
      progressBar.style.width = total > 0 ? `${Math.min(100, (scrolled / total) * 100)}%` : '0%';
    }
    window.addEventListener('scroll', updateProgress, { passive: true });

    // ── Back to top ──
    const backBtn = document.getElementById('back-to-top') as HTMLButtonElement;
    window.addEventListener('scroll', () => {
      backBtn?.classList.toggle('visible', window.scrollY > 400);
    }, { passive: true });
    backBtn?.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));

    // ── Copy code buttons ──
    document.querySelectorAll('.prose pre').forEach((pre) => {
      const btn = document.createElement('button');
      btn.className = 'code-copy-btn';
      btn.textContent = 'Copiar';
      btn.addEventListener('click', async () => {
        const code = pre.querySelector('code')?.textContent ?? '';
        await navigator.clipboard.writeText(code);
        btn.textContent = '✓ Copiado!';
        setTimeout(() => { btn.textContent = 'Copiar'; }, 2000);
      });
      (pre as HTMLElement).style.position = 'relative';
      pre.appendChild(btn);
    });

    // ── Image zoom (lightbox) ──
    const lightbox = document.getElementById('img-lightbox') as HTMLDivElement;
    const lightboxImg = document.getElementById('img-lightbox-src') as HTMLImageElement;
    document.querySelectorAll('.prose img, [data-zoomable]').forEach((img) => {
      (img as HTMLElement).style.cursor = 'zoom-in';
      img.addEventListener('click', () => {
        // Use original URL (data-full) for lightbox when available, for best quality
        const el = img as HTMLImageElement;
        lightboxImg.src = el.dataset.full ?? el.src;
        lightboxImg.alt = el.alt;
        lightbox.style.display = 'flex';
        document.body.style.overflow = 'hidden';
      });
    });
    lightbox?.addEventListener('click', () => {
      lightbox.style.display = 'none';
      document.body.style.overflow = '';
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') { lightbox.style.display = 'none'; document.body.style.overflow = ''; }
    });
  </script>
</body>
</html>
