---
import Header from '../../components/Header.astro';
import AdminNav from '../../components/admin/AdminNav.astro';
import { getDb, posts } from '../../lib/db';
import '../../styles/global.css';

const db = getDb(Astro.locals.runtime.env.DB);

const allPosts = await db.select().from(posts).all();
const published = allPosts.filter((p) => p.status === 'published');
const drafts = allPosts.filter((p) => p.status === 'draft');
const totalViews = allPosts.reduce((sum, p) => sum + p.views, 0);

const stats = [
  { label: 'Posts publicados', value: published.length, color: 'text-green-400' },
  { label: 'Rascunhos', value: drafts.length, color: 'text-yellow-400' },
  { label: 'Total de posts', value: allPosts.length, color: 'text-indigo-400' },
  { label: 'Visualizações totais', value: totalViews, color: 'text-blue-400' },
];

const recentPosts = allPosts
  .sort((a, b) => b.updatedAt - a.updatedAt)
  .slice(0, 5);
---

<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin — Blog do Thiago</title>
  <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
</head>
<body class="bg-zinc-950 text-zinc-100 min-h-screen">
  <Header />

  <div class="max-w-5xl mx-auto px-4 py-8 flex gap-8">
    <AdminNav />

    <div class="flex-1 min-w-0">
      <div class="flex items-center justify-between mb-8">
        <h1 class="text-2xl font-bold">Dashboard</h1>
        <a href="/admin/posts/new" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg text-sm font-medium transition-colors">
          + Novo post
        </a>
      </div>

      <!-- Stats -->
      <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-8">
        {stats.map(({ label, value, color }) => (
          <div class="bg-zinc-900 border border-zinc-800 rounded-xl p-4">
            <p class={`text-2xl font-bold ${color}`}>{value}</p>
            <p class="text-xs text-zinc-500 mt-1">{label}</p>
          </div>
        ))}
      </div>

      <!-- Recent posts -->
      <div>
        <h2 class="text-sm font-medium text-zinc-500 mb-3 uppercase tracking-wider">Posts recentes</h2>
        {recentPosts.length === 0 ? (
          <div class="bg-zinc-900 border border-zinc-800 rounded-xl p-8 text-center text-zinc-600">
            Nenhum post ainda. <a href="/admin/posts/new" class="text-indigo-400 hover:text-indigo-300">Criar primeiro post</a>
          </div>
        ) : (
          <div class="space-y-2">
            {recentPosts.map((post) => (
              <a href={`/admin/posts/${post.id}`} class="flex items-center justify-between bg-zinc-900 border border-zinc-800 hover:border-zinc-700 rounded-lg px-4 py-3 transition-colors group">
                <div>
                  <p class="text-sm font-medium text-zinc-200 group-hover:text-zinc-100">{post.title}</p>
                  <p class="text-xs text-zinc-600 mt-0.5">/blog/{post.slug}</p>
                </div>
                <span class={`text-xs px-2 py-0.5 rounded-full font-medium ${
                  post.status === 'published'
                    ? 'bg-green-500/10 text-green-400'
                    : 'bg-yellow-500/10 text-yellow-400'
                }`}>
                  {post.status === 'published' ? 'Publicado' : 'Rascunho'}
                </span>
              </a>
            ))}
          </div>
        )}
      </div>
    </div>
  </div>
</body>
</html>
