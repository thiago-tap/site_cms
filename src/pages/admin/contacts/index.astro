---
import Header from '../../../components/Header.astro';
import AdminNav from '../../../components/admin/AdminNav.astro';
import { getDb, contacts } from '../../../lib/db';
import { eq } from 'drizzle-orm';
import { formatDate } from '../../../lib/utils';
import '../../../styles/global.css';

const db = getDb(Astro.locals.runtime.env.DB);

if (Astro.request.method === 'POST') {
  const form = await Astro.request.formData();
  const action = form.get('_action') as string;
  const id = form.get('id') as string;
  if (action === 'read' && id) {
    await db.update(contacts).set({ read: 1 }).where(eq(contacts.id, id));
  } else if (action === 'delete' && id) {
    await db.delete(contacts).where(eq(contacts.id, id));
  }
}

const allContacts = await db
  .select()
  .from(contacts)
  .orderBy((c) => c.createdAt)
  .all();

// Sort newest first
allContacts.sort((a, b) => b.createdAt - a.createdAt);

const unread = allContacts.filter((c) => !c.read).length;
---

<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Contatos â€” Admin</title>
  <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
</head>
<body class="bg-zinc-950 text-zinc-100 min-h-screen">
  <Header />

  <div class="max-w-5xl mx-auto px-4 py-8 flex gap-8">
    <AdminNav />

    <div class="flex-1 min-w-0">
      <div class="flex items-center gap-3 mb-8">
        <h1 class="text-2xl font-bold">Mensagens de Contato</h1>
        {unread > 0 && (
          <span class="px-2 py-0.5 bg-indigo-600 text-white text-xs rounded-full font-medium">
            {unread} nova{unread > 1 ? 's' : ''}
          </span>
        )}
      </div>

      {allContacts.length === 0 ? (
        <div class="bg-zinc-900 border border-zinc-800 rounded-xl p-10 text-center text-zinc-600">
          Nenhuma mensagem ainda.
        </div>
      ) : (
        <div class="space-y-3">
          {allContacts.map((contact) => (
            <div class={`bg-zinc-900 border rounded-xl p-5 ${contact.read ? 'border-zinc-800' : 'border-indigo-500/30'}`}>
              <div class="flex items-start justify-between gap-4 mb-3">
                <div>
                  <div class="flex items-center gap-2">
                    <p class="font-medium text-zinc-200">{contact.name}</p>
                    {!contact.read && <span class="text-xs bg-indigo-600/20 text-indigo-400 px-1.5 py-0.5 rounded">Nova</span>}
                  </div>
                  <p class="text-sm text-zinc-500">{contact.email}</p>
                  {contact.subject && <p class="text-sm text-zinc-400 mt-0.5">Assunto: {contact.subject}</p>}
                </div>
                <span class="text-xs text-zinc-600 shrink-0">{formatDate(contact.createdAt)}</span>
              </div>

              <p class="text-sm text-zinc-300 leading-relaxed whitespace-pre-wrap mb-4">{contact.message}</p>

              <div class="flex gap-2">
                <a href={`mailto:${contact.email}?subject=Re: ${contact.subject || 'Contato'}`}
                  class="text-xs px-3 py-1.5 bg-indigo-600/10 hover:bg-indigo-600/20 text-indigo-400 rounded-md transition-colors">
                  Responder por email
                </a>
                {!contact.read && (
                  <form method="POST" class="inline">
                    <input type="hidden" name="_action" value="read" />
                    <input type="hidden" name="id" value={contact.id} />
                    <button type="submit" class="text-xs px-3 py-1.5 bg-zinc-800 hover:bg-zinc-700 text-zinc-400 rounded-md transition-colors">
                      Marcar como lida
                    </button>
                  </form>
                )}
                <form method="POST" class="inline">
                  <input type="hidden" name="_action" value="delete" />
                  <input type="hidden" name="id" value={contact.id} />
                  <button type="submit" onclick="return confirm('Excluir esta mensagem?')"
                    class="text-xs px-3 py-1.5 bg-red-600/10 hover:bg-red-600/20 text-red-400 rounded-md transition-colors">
                    Excluir
                  </button>
                </form>
              </div>
            </div>
          ))}
        </div>
      )}
    </div>
  </div>
</body>
</html>
