---
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import SEO from '../components/SEO.astro';
import PostCard from '../components/PostCard.astro';
import TrackingScripts from '../components/TrackingScripts.astro';
import { getDb, posts } from '../lib/db';
import { eq, like, or, and, desc } from 'drizzle-orm';
import { getSettings } from '../lib/settings';
import '../styles/global.css';

const config = await getSettings(Astro.locals.runtime.env.DB);
const query = Astro.url.searchParams.get('q')?.trim() ?? '';

let results: typeof posts.$inferSelect[] = [];

if (query.length >= 2) {
  const db = getDb(Astro.locals.runtime.env.DB);
  const q = `%${query}%`;
  results = await db
    .select()
    .from(posts)
    .where(
      and(
        eq(posts.status, 'published'),
        or(
          like(posts.title, q),
          like(posts.excerpt, q),
          like(posts.tags, q),
        )
      )
    )
    .orderBy(desc(posts.publishedAt))
    .all();
}
---

<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <SEO
    title={query ? `Busca: ${query}` : 'Busca'}
    description={`Pesquise posts em ${config.site_name}`}
    siteName={config.site_name}
    siteUrl={Astro.locals.runtime.env.SITE_URL}
  />
  <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
  <TrackingScripts />
</head>
<body class="bg-zinc-950 text-zinc-100 min-h-screen flex flex-col">
  <Header />

  <main class="max-w-4xl mx-auto px-4 py-12 flex-1 w-full">
    <h1 class="text-3xl font-bold text-zinc-100 mb-8">Busca</h1>

    <form method="GET" action="/busca" class="mb-8">
      <div class="flex gap-2">
        <input
          name="q"
          type="search"
          value={query}
          placeholder="Pesquisar posts..."
          autofocus
          class="flex-1 bg-zinc-900 border border-zinc-700 rounded-lg px-4 py-2.5 text-sm text-zinc-100 placeholder-zinc-600 focus:outline-none focus:border-indigo-500 transition-colors"
        />
        <button type="submit"
          class="px-5 py-2.5 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg text-sm font-medium transition-colors">
          Buscar
        </button>
      </div>
    </form>

    {query.length >= 2 && (
      <div>
        <p class="text-sm text-zinc-500 mb-5">
          {results.length === 0
            ? `Nenhum resultado para "${query}"`
            : `${results.length} resultado${results.length !== 1 ? 's' : ''} para "${query}"`}
        </p>
        {results.length > 0 && (
          <div class="grid gap-4 sm:grid-cols-2">
            {results.map((post) => <PostCard post={post} />)}
          </div>
        )}
      </div>
    )}

    {query.length < 2 && query.length > 0 && (
      <p class="text-sm text-zinc-500">Digite pelo menos 2 caracteres para buscar.</p>
    )}
  </main>

  <Footer />
</body>
</html>
