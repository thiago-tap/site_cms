---
import { getSettings } from '../lib/settings';
const user = Astro.locals.user;
const path = Astro.url.pathname;
const config = Astro.locals.runtime?.env?.DB
  ? await getSettings(Astro.locals.runtime.env.DB)
  : null;
const siteName = config?.site_name ?? 'Blog do Thiago';
const logoUrl = config?.logo_url ?? '';
---

<!-- FOUC prevention: apply saved theme before first paint -->
<script is:inline>
  (function () {
    const t = localStorage.getItem('theme');
    if (t) document.documentElement.setAttribute('data-theme', t);
  })();
</script>

<header class="sticky top-0 z-50 bg-zinc-950/80 backdrop-blur-sm border-b border-zinc-800">
  <div class="max-w-4xl mx-auto px-4 h-14 flex items-center justify-between">
    <a href="/" class="flex items-center gap-2 font-bold text-zinc-100 hover:text-white transition-colors">
      {logoUrl ? (
        <img src={logoUrl} alt={siteName} class="h-6 w-auto" />
      ) : (
        <svg class="w-5 h-5 text-indigo-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/>
        </svg>
      )}
      {siteName}
    </a>

    <nav class="flex items-center gap-4">
      <a href="/" class={`text-sm transition-colors ${path === '/' ? 'text-zinc-100' : 'text-zinc-400 hover:text-zinc-100'}`}>Blog</a>
      <a href="/tags" class={`text-sm transition-colors ${path === '/tags' ? 'text-zinc-100' : 'text-zinc-400 hover:text-zinc-100'}`}>Tags</a>
      <a href="/sobre" class={`text-sm transition-colors ${path === '/sobre' ? 'text-zinc-100' : 'text-zinc-400 hover:text-zinc-100'}`}>Sobre</a>
      <a href="/contato" class={`text-sm transition-colors ${path === '/contato' ? 'text-zinc-100' : 'text-zinc-400 hover:text-zinc-100'}`}>Contato</a>
      <a href="/busca" title="Buscar (Ctrl+K)" class="flex items-center gap-1.5 text-zinc-400 hover:text-zinc-100 transition-colors">
        <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
        </svg>
        <kbd class="hidden sm:inline-flex items-center gap-0.5 px-1.5 py-0.5 text-[10px] font-mono bg-zinc-800 border border-zinc-700 text-zinc-500 rounded">
          <span class="text-[11px]">⌘</span>K
        </kbd>
      </a>

      <!-- Theme toggle -->
      <button id="theme-toggle" aria-label="Alternar tema claro/escuro" title="Alternar tema" class="text-zinc-400 hover:text-zinc-100 transition-colors">
        <!-- Sun icon (shown in dark mode → click to switch to light) -->
        <svg id="icon-sun" class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="5"/>
          <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
        </svg>
        <!-- Moon icon (shown in light mode → click to switch to dark) -->
        <svg id="icon-moon" class="w-4 h-4 hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
        </svg>
      </button>

      {user ? (
        <>
          <a href="/admin" class={`text-sm transition-colors ${path.startsWith('/admin') ? 'text-indigo-400' : 'text-zinc-400 hover:text-zinc-100'}`}>Admin</a>
          <form action="/auth/logout" method="POST">
            <button type="submit" class="flex items-center gap-2 text-sm text-zinc-500 hover:text-zinc-100 transition-colors">
              <img src={user.avatarUrl ?? `https://github.com/${user.username}.png`} alt={user.username} class="w-6 h-6 rounded-full" />
              Sair
            </button>
          </form>
        </>
      ) : (
        <a href="/auth/github" class="text-sm px-3 py-1.5 bg-indigo-600 hover:bg-indigo-500 text-white rounded-md transition-colors">Login</a>
      )}
    </nav>
  </div>
</header>

<script>
  // ── Ctrl+K search shortcut ──
  document.addEventListener('keydown', (e) => {
    if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
      e.preventDefault();
      window.location.href = '/busca';
    }
  });

  // ── Theme toggle ──
  const root = document.documentElement;
  const sun = document.getElementById('icon-sun') as HTMLElement | null;
  const moon = document.getElementById('icon-moon') as HTMLElement | null;

  function applyTheme(theme: string) {
    root.setAttribute('data-theme', theme);
    if (theme === 'light') {
      sun?.classList.add('hidden');
      moon?.classList.remove('hidden');
    } else {
      sun?.classList.remove('hidden');
      moon?.classList.add('hidden');
    }
  }

  // Sync icons with current theme on load
  applyTheme(root.getAttribute('data-theme') ?? 'dark');

  document.getElementById('theme-toggle')?.addEventListener('click', () => {
    const current = root.getAttribute('data-theme') ?? 'dark';
    const next = current === 'dark' ? 'light' : 'dark';
    localStorage.setItem('theme', next);
    applyTheme(next);
  });
</script>
