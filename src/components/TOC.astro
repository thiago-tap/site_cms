---
interface Props {
  headings: { depth: number; text: string; slug: string }[];
  /** 'inline' = collapsible card (default), 'sidebar' = compact always-open */
  variant?: 'inline' | 'sidebar';
}
const { headings, variant = 'inline' } = Astro.props;
const isSidebar = variant === 'sidebar';
---

{headings.length > 1 && (
  <nav
    data-toc
    data-variant={variant}
    class:list={[
      'not-prose',
      isSidebar
        ? 'text-sm'
        : 'bg-zinc-900 border border-zinc-800 rounded-xl p-5 mb-8',
    ]}
  >
    {isSidebar ? (
      <p class="text-xs font-semibold text-zinc-500 uppercase tracking-wider mb-3">Índice</p>
    ) : (
      <button data-toc-toggle class="flex items-center justify-between w-full text-left">
        <p class="text-xs font-semibold text-zinc-500 uppercase tracking-wider">Índice</p>
        <svg data-toc-chevron class="w-4 h-4 text-zinc-600 transition-transform" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M6 9l6 6 6-6"/>
        </svg>
      </button>
    )}
    <ol data-toc-list class:list={['space-y-1.5', !isSidebar && 'mt-3']}>
      {headings.map(({ depth, text, slug }) => (
        <li class={depth === 3 ? 'ml-3' : ''}>
          <a
            href={`#${slug}`}
            data-slug={slug}
            class:list={[
              'toc-link block transition-colors hover:text-indigo-400',
              isSidebar ? 'text-xs text-zinc-500 py-0.5 leading-snug' : 'text-sm text-zinc-400',
            ]}
          >
            {text}
          </a>
        </li>
      ))}
    </ol>
  </nav>
)}

<script>
  // Toggle for inline variant
  document.querySelectorAll('[data-toc]').forEach((nav) => {
    if (nav.getAttribute('data-variant') === 'sidebar') return;
    const toggle = nav.querySelector('[data-toc-toggle]');
    const list = nav.querySelector('[data-toc-list]') as HTMLElement | null;
    const chevron = nav.querySelector('[data-toc-chevron]') as HTMLElement | null;
    toggle?.addEventListener('click', () => {
      const hidden = list?.style.display === 'none';
      if (list) list.style.display = hidden ? '' : 'none';
      chevron?.style.setProperty('transform', hidden ? '' : 'rotate(-90deg)');
    });
  });

  // Highlight active heading — shared across all TOC instances
  const allLinks = document.querySelectorAll<HTMLAnchorElement>('.toc-link');
  const headingEls = Array.from(
    new Set(Array.from(allLinks).map((a) => a.dataset.slug))
  )
    .map((slug) => document.getElementById(slug!))
    .filter(Boolean) as HTMLElement[];

  function highlightActive() {
    let active = headingEls[0];
    for (const h of headingEls) {
      if (h.getBoundingClientRect().top <= 112) active = h;
    }
    allLinks.forEach((a) => {
      const isActive = a.dataset.slug === active?.id;
      a.classList.toggle('text-indigo-400', isActive);
      a.classList.toggle('font-medium', isActive);
      // reset non-active to variant default
      const isSidebar = a.closest('[data-toc]')?.getAttribute('data-variant') === 'sidebar';
      if (!isActive) {
        a.classList.toggle('text-zinc-500', isSidebar);
        a.classList.toggle('text-zinc-400', !isSidebar);
      }
    });
  }
  window.addEventListener('scroll', highlightActive, { passive: true });
  highlightActive();
</script>
